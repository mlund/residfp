use resid::{ChipModel, Sid};

const CPU_FREQ: u32 = 985248;
const SAMPLE_FREQ: u32 = 44100;
const SAMPLE_COUNT: usize = 128;
const CYCLES_PER_SAMPLE: u32 = CPU_FREQ / SAMPLE_FREQ;

fn dump(sid: &mut Sid, _name: &str, samples: usize) -> Vec<i16> {
    let mut buffer = vec![0; samples];
    let _ = sid.sample(samples as u32 * CYCLES_PER_SAMPLE, &mut buffer, 1);
    buffer
}

fn setup(sid: &mut Sid, voice: u8, waveform: u8, freq: u16, pw: u16, vol: u8) {
    let offset = voice * 7;
    let control = (waveform << 4) | 1;
    sid.write(offset + 0x00, (freq & 0x00ff) as u8); // FREQ_LO
    sid.write(offset + 0x01, (freq >> 8) as u8); // FREQ_HI
    sid.write(offset + 0x02, (pw & 0x00ff) as u8); // PW_LO
    sid.write(offset + 0x03, (pw >> 8) as u8); // PW_HI
    sid.write(offset + 0x04, control); // CONTROL
    sid.write(offset + 0x05, 9); // ATTACK_DECAY
    sid.write(offset + 0x06, 0); // SUSTAIN_RELEASE
    sid.write(0x18, vol); // MODE_VOL
}

#[test]
fn filter_off() {
    let expected: Vec<i16> = vec![
        -21211, -21145, -21135, -21130, -20942, -20902, -20862, -20822, -20779, -20756, -20688,
        -20658, -20649, -20610, -20077, -20006, -19944, -19890, -19771, -19749, -19673, -19602,
        -19514, -19444, -19368, -19429, -19311, -19256, -19194, -19124, -19022, -18952, -18929,
        -18853, -18783, -18695, -18624, -18548, -18555, -18436, -18383, -18320, -18249, -18148,
        -18077, -18032, -17979, -17860, -17820, -17744, -19188, -17791, -17720, -17644, -17605,
        -17486, -17431, -17388, -17317, -17263, -17144, -17104, -17029, -16958, -16916, -16847,
        -16770, -16730, -16611, -16557, -18530, -18490, -18432, -18392, -16208, -16154, -16035,
        -16096, -16021, -15950, -15861, -15792, -15715, -15693, -15575, -15520, -15458, -15388,
        -15335, -15216, -15222, -15146, -15076, -14988, -14917, -14841, -14819, -14700, -14646,
        -14584, -14513, -17338, -14341, -14341, -14341, -14341, -14341, -14341, -14341, -14341,
        -14341, -14341, -14341, -14341, -17297, -17297, -17297, -17297, -17297, -17297, -17297,
        -17297, -17297, -17297, -17297, -17297, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(false);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    let res = dump(&mut sid, "filter_off", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_on() {
    let expected: Vec<i16> = vec![
        -21211, -21145, -21135, -21130, -20942, -20902, -20862, -20822, -20779, -20756, -20688,
        -20658, -20649, -20610, -20077, -20006, -19944, -19890, -19771, -19749, -19673, -19602,
        -19514, -19444, -19368, -19429, -19311, -19256, -19194, -19124, -19022, -18952, -18929,
        -18853, -18783, -18695, -18624, -18548, -18555, -18436, -18383, -18320, -18249, -18148,
        -18077, -18032, -17979, -17860, -17820, -17744, -19188, -17791, -17720, -17644, -17605,
        -17486, -17431, -17388, -17317, -17263, -17144, -17104, -17029, -16958, -16916, -16847,
        -16770, -16730, -16611, -16557, -18530, -18490, -18432, -18392, -16208, -16154, -16035,
        -16096, -16021, -15950, -15861, -15792, -15715, -15693, -15575, -15520, -15458, -15388,
        -15335, -15216, -15222, -15146, -15076, -14988, -14917, -14841, -14819, -14700, -14646,
        -14584, -14513, -17338, -14341, -14341, -14341, -14341, -14341, -14341, -14341, -14341,
        -14341, -14341, -14341, -14341, -17297, -17297, -17297, -17297, -17297, -17297, -17297,
        -17297, -17297, -17297, -17297, -17297, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    let res = dump(&mut sid, "filter_on", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_vol_8() {
    let expected: Vec<i16> = vec![
        -16963, -16829, -16811, -16800, -16424, -16344, -16264, -16184, -16098, -16052, -15917,
        -15856, -15839, -15760, -14693, -14552, -14427, -14320, -14083, -14039, -13886, -13744,
        -13568, -13428, -13275, -13397, -13162, -13053, -12928, -12789, -12584, -12444, -12398,
        -12245, -12106, -11929, -11787, -11637, -11650, -11412, -11305, -11181, -11039, -10836,
        -10694, -10605, -10498, -10260, -10179, -10029, -12917, -10123, -9981, -9828, -9749, -9512,
        -9403, -9315, -9173, -9067, -8829, -8748, -8597, -8456, -8373, -8233, -8080, -8000, -7762,
        -7655, -11600, -11520, -11404, -11323, -6957, -6848, -6610, -6732, -6581, -6440, -6263,
        -6123, -5971, -5927, -5689, -5580, -5456, -5316, -5209, -4971, -4984, -4832, -4692, -4515,
        -4373, -4223, -4177, -3939, -3832, -3708, -3566, -9216, -3221, -3221, -3221, -3221, -3221,
        -3221, -3221, -3221, -3221, -3221, -3221, -3221, -9135, -9135, -9135, -9135, -9135, -9135,
        -9135, -9135, -9135, -9135, -9135, -9135, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    sid.write(0x18, 8); // MODE_VOL
    let res = dump(&mut sid, "filter_vol_8", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_voice3_off() {
    let expected: Vec<i16> = vec![
        -22683, -22703, -22717, -22725, -22562, -22546, -22529, -22513, -22495, -22485, -22457,
        -22445, -22441, -22425, -21926, -21879, -21837, -21802, -21723, -21708, -21657, -21610,
        -21551, -21504, -21453, -21494, -21416, -21379, -21338, -21291, -21223, -21176, -21161,
        -21110, -21064, -21005, -20957, -20907, -20912, -20832, -20797, -20755, -20708, -20640,
        -20593, -20563, -20528, -20448, -20421, -20371, -20324, -20403, -20355, -20304, -20278,
        -20199, -20163, -20133, -20086, -20051, -19971, -19944, -19894, -19847, -19819, -19773,
        -19722, -19695, -19616, -19580, -21567, -21551, -21527, -21510, -19347, -19311, -19232,
        -19272, -19222, -19175, -19116, -19069, -19019, -19004, -18925, -18888, -18847, -18800,
        -18765, -18685, -18690, -18639, -18592, -18533, -18486, -18436, -18421, -18341, -18306,
        -18264, -18217, -18149, -18102, -18102, -18102, -18102, -18102, -18102, -18102, -18102,
        -18102, -18102, -18102, -18102, -21059, -21059, -21059, -21059, -21059, -21059, -21059,
        -21059, -21059, -21059, -21059, -21059, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    sid.write(0x18, (0x08 << 4) | 0x04); // MODE_VOL
    let res = dump(&mut sid, "filter_voice3_off", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_hp_lp_lp() {
    let expected: Vec<i16> = vec![
        -21211, -21145, -21135, -21130, -20942, -20902, -20862, -20822, -20779, -20756, -20688,
        -20658, -20649, -20610, -20077, -20006, -19944, -19890, -19771, -19749, -19673, -19602,
        -19514, -19444, -19368, -19429, -19311, -19256, -19194, -19124, -19022, -18952, -18929,
        -18853, -18783, -18695, -18624, -18548, -18555, -18436, -18383, -18320, -18249, -18148,
        -18077, -18032, -17979, -17860, -17820, -17744, -19188, -17791, -17720, -17644, -17605,
        -17486, -17431, -17388, -17317, -17263, -17144, -17104, -17029, -16958, -16916, -16847,
        -16770, -16730, -16611, -16557, -18530, -18490, -18432, -18392, -16208, -16154, -16035,
        -16096, -16021, -15950, -15861, -15792, -15715, -15693, -15575, -15520, -15458, -15388,
        -15335, -15216, -15222, -15146, -15076, -14988, -14917, -14841, -14819, -14700, -14646,
        -14584, -14513, -17338, -14341, -14341, -14341, -14341, -14341, -14341, -14341, -14341,
        -14341, -14341, -14341, -14341, -17297, -17297, -17297, -17297, -17297, -17297, -17297,
        -17297, -17297, -17297, -17297, -17297, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    sid.write(0x18, (0x07 << 4) | 0x04); // MODE_VOL
    let res = dump(&mut sid, "filter_hp_lp_lp", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_filt_15() {
    let expected: Vec<i16> = vec![
        -29834, -29572, -29279, -28995, -28885, -28647, -28420, -28190, -27986, -27773, -27602,
        -27413, -27214, -27048, -27369, -27224, -27068, -26923, -26847, -26675, -26573, -26466,
        -26391, -26302, -26220, -26020, -26006, -25928, -25871, -25828, -25816, -25781, -25708,
        -25688, -25672, -25678, -25667, -25669, -25597, -25651, -25647, -25655, -25675, -25730,
        -25757, -25760, -25779, -25865, -25873, -25922, -24526, -25947, -26009, -26078, -26113,
        -26228, -26281, -26327, -26401, -26460, -26585, -26634, -26719, -26801, -26857, -26943,
        -27036, -27095, -27232, -27304, -25447, -25659, -25878, -26076, -28313, -28367, -28484,
        -28428, -28512, -28593, -28691, -28771, -28856, -28892, -29023, -29089, -29166, -29249,
        -29318, -29451, -29461, -29556, -29645, -29750, -29837, -29931, -29973, -30109, -30182,
        -30263, -30353, -27691, -30775, -30785, -30801, -30823, -30850, -30881, -30915, -30954,
        -30996, -31040, -31091, -31143, -28379, -28656, -28914, -29167, -29424, -29664, -29897,
        -30134, -30356, -30572, -30791, -30994, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    sid.write(0x17, 0x0f); // RESFILT
    sid.write(0x18, (0x07 << 4) | 0x04); // MODE_VOL
    let res = dump(&mut sid, "filter_filt_15", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_res_15() {
    let expected: Vec<i16> = vec![
        -21211, -21145, -21135, -21130, -20942, -20902, -20862, -20822, -20779, -20756, -20688,
        -20658, -20649, -20610, -20077, -20006, -19944, -19890, -19771, -19749, -19673, -19602,
        -19514, -19444, -19368, -19429, -19311, -19256, -19194, -19124, -19022, -18952, -18929,
        -18853, -18783, -18695, -18624, -18548, -18555, -18436, -18383, -18320, -18249, -18148,
        -18077, -18032, -17979, -17860, -17820, -17744, -19188, -17791, -17720, -17644, -17605,
        -17486, -17431, -17388, -17317, -17263, -17144, -17104, -17029, -16958, -16916, -16847,
        -16770, -16730, -16611, -16557, -18530, -18490, -18432, -18392, -16208, -16154, -16035,
        -16096, -16021, -15950, -15861, -15792, -15715, -15693, -15575, -15520, -15458, -15388,
        -15335, -15216, -15222, -15146, -15076, -14988, -14917, -14841, -14819, -14700, -14646,
        -14584, -14513, -17338, -14341, -14341, -14341, -14341, -14341, -14341, -14341, -14341,
        -14341, -14341, -14341, -14341, -17297, -17297, -17297, -17297, -17297, -17297, -17297,
        -17297, -17297, -17297, -17297, -17297, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    sid.write(0x17, 0xf0); // RESFILT
    sid.write(0x18, (0x07 << 4) | 0x04); // MODE_VOL
    let res = dump(&mut sid, "filter_res_15", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_fc_255() {
    let expected: Vec<i16> = vec![
        -21211, -21145, -21135, -21130, -20942, -20902, -20862, -20822, -20779, -20756, -20688,
        -20658, -20649, -20610, -20077, -20006, -19944, -19890, -19771, -19749, -19673, -19602,
        -19514, -19444, -19368, -19429, -19311, -19256, -19194, -19124, -19022, -18952, -18929,
        -18853, -18783, -18695, -18624, -18548, -18555, -18436, -18383, -18320, -18249, -18148,
        -18077, -18032, -17979, -17860, -17820, -17744, -19188, -17791, -17720, -17644, -17605,
        -17486, -17431, -17388, -17317, -17263, -17144, -17104, -17029, -16958, -16916, -16847,
        -16770, -16730, -16611, -16557, -18530, -18490, -18432, -18392, -16208, -16154, -16035,
        -16096, -16021, -15950, -15861, -15792, -15715, -15693, -15575, -15520, -15458, -15388,
        -15335, -15216, -15222, -15146, -15076, -14988, -14917, -14841, -14819, -14700, -14646,
        -14584, -14513, -17338, -14341, -14341, -14341, -14341, -14341, -14341, -14341, -14341,
        -14341, -14341, -14341, -14341, -17297, -17297, -17297, -17297, -17297, -17297, -17297,
        -17297, -17297, -17297, -17297, -17297, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    sid.write(0x15, 0xff); // FCLO
    sid.write(0x18, (0x07 << 4) | 0x04); // MODE_VOL
    let res = dump(&mut sid, "filter_fc_255", SAMPLE_COUNT);
    assert_eq!(res, expected);
}

#[test]
fn filter_fc_res_filt() {
    let expected: Vec<i16> = vec![
        -29904, -29749, -29550, -29351, -29323, -29155, -28992, -28822, -28668, -28496, -28364,
        -28206, -28032, -27884, -28227, -28103, -27964, -27829, -27761, -27592, -27489, -27377,
        -27294, -27196, -27100, -26882, -26848, -26748, -26666, -26596, -26556, -26493, -26389,
        -26339, -26291, -26265, -26222, -26192, -26087, -26107, -26072, -26049, -26036, -26061,
        -26059, -26034, -26025, -26086, -26069, -26095, -24652, -26037, -26080, -26131, -26148,
        -26250, -26291, -26325, -26392, -26444, -26565, -26611, -26696, -26780, -26839, -26930,
        -27031, -27099, -27249, -27335, -25461, -25643, -25839, -26019, -28280, -28376, -28537,
        -28526, -28653, -28778, -28923, -29050, -29184, -29269, -29449, -29566, -29695, -29831,
        -29951, -30139, -30202, -30348, -30494, -30654, -30797, -30947, -31044, -31236, -31367,
        -31503, -31648, -28996, -32115, -32188, -32267, -32345, -32430, -32514, -32600, -32694,
        -32768, -32768, -32768, -32768, -30308, -30560, -30800, -31038, -31286, -31521, -31754,
        -31996, -32225, -32452, -32685, -32768, 0, 0,
    ];
    let mut sid = Sid::new(ChipModel::Mos6581);
    sid.enable_external_filter(false);
    sid.enable_filter(true);
    setup(&mut sid, 0, 4, 0x19b1, 0x0200, 4);
    setup(&mut sid, 1, 4, 0x29b1, 0x0100, 4);
    setup(&mut sid, 2, 4, 0x39b1, 0x0050, 4);
    sid.write(0x15, 0xff); // FCLO
    sid.write(0x17, 0xff); // RESFILT
    sid.write(0x18, (0x07 << 4) | 0x04); // MODE_VOL
    let res = dump(&mut sid, "filter_fc_res_filt", SAMPLE_COUNT);
    assert_eq!(res, expected);
}
